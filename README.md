# NixOS 22.11 (Raccoon) é…ç½®å®‰è£…æ•™ç¨‹

```
â”ŒğŸ’  jcleng @ ğŸ’»  nixos in ğŸ“  caddy-pl on ğŸŒ¿  main â€¢1 âœ—
â””â¯ neofetch
          â–—â–„â–„â–„       â–—â–„â–„â–„â–„    â–„â–„â–„â––            jcleng@nixos
          â–œâ–ˆâ–ˆâ–ˆâ–™       â–œâ–ˆâ–ˆâ–ˆâ–™  â–Ÿâ–ˆâ–ˆâ–ˆâ–›            ------------
           â–œâ–ˆâ–ˆâ–ˆâ–™       â–œâ–ˆâ–ˆâ–ˆâ–™â–Ÿâ–ˆâ–ˆâ–ˆâ–›             OS: NixOS 22.11.2804.b26d52c9feb (Raccoon) x86_64
            â–œâ–ˆâ–ˆâ–ˆâ–™       â–œâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–›              Host: LENOVO 20FRS0UM00
     â–Ÿâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–™ â–œâ–ˆâ–ˆâ–ˆâ–ˆâ–›     â–Ÿâ–™        Kernel: 5.15.95
    â–Ÿâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–™ â–œâ–ˆâ–ˆâ–ˆâ–™    â–Ÿâ–ˆâ–ˆâ–™       Uptime: 12 hours, 17 mins
           â–„â–„â–„â–„â––           â–œâ–ˆâ–ˆâ–ˆâ–™  â–Ÿâ–ˆâ–ˆâ–ˆâ–›       Packages: 1951 (nix-system), 564 (nix-user), 42 (flatpak)
          â–Ÿâ–ˆâ–ˆâ–ˆâ–›             â–œâ–ˆâ–ˆâ–› â–Ÿâ–ˆâ–ˆâ–ˆâ–›        Shell: bash 5.1.16
         â–Ÿâ–ˆâ–ˆâ–ˆâ–›               â–œâ–› â–Ÿâ–ˆâ–ˆâ–ˆâ–›         Resolution: 2560x1440
â–Ÿâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–›                  â–Ÿâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–™   Terminal: vscode
â–œâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–›                  â–Ÿâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–›   CPU: Intel i5-6300U (4) @ 3.000GHz
      â–Ÿâ–ˆâ–ˆâ–ˆâ–› â–Ÿâ–™               â–Ÿâ–ˆâ–ˆâ–ˆâ–›            GPU: Intel Skylake GT2 [HD Graphics 520]
     â–Ÿâ–ˆâ–ˆâ–ˆâ–› â–Ÿâ–ˆâ–ˆâ–™             â–Ÿâ–ˆâ–ˆâ–ˆâ–›             Memory: 1852MiB / 7825MiB
    â–Ÿâ–ˆâ–ˆâ–ˆâ–›  â–œâ–ˆâ–ˆâ–ˆâ–™           â–â–€â–€â–€â–€
    â–œâ–ˆâ–ˆâ–›    â–œâ–ˆâ–ˆâ–ˆâ–™ â–œâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–›
     â–œâ–›     â–Ÿâ–ˆâ–ˆâ–ˆâ–ˆâ–™ â–œâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–›
           â–Ÿâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–™       â–œâ–ˆâ–ˆâ–ˆâ–™
          â–Ÿâ–ˆâ–ˆâ–ˆâ–›â–œâ–ˆâ–ˆâ–ˆâ–™       â–œâ–ˆâ–ˆâ–ˆâ–™
         â–Ÿâ–ˆâ–ˆâ–ˆâ–›  â–œâ–ˆâ–ˆâ–ˆâ–™       â–œâ–ˆâ–ˆâ–ˆâ–™
         â–â–€â–€â–€    â–€â–€â–€â–€â–˜       â–€â–€â–€â–˜




```

## å¯åŠ¨é•œåƒè¿›å…¥å›¾å½¢åŒ–ç•Œé¢
> çƒ§å†™å›¾å½¢ç‰ˆnixos-graphicalé•œåƒåˆ°Uç›˜
> åœ¨linuxé‡Œé¢
```shell
sudo dd if=nix.iso of=/dev/sdc bs=4M conv=fsync
```
* é»˜è®¤çš„å¯åŠ¨é¡¹è¿›ä¸å»å°±å¯ä»¥è¯•ä¸€è¯•ç¬¬äºŒä¸ªé€‰é¡¹(nomodeset)
* å¯åŠ¨è¿›å…¥å‘½ä»¤è¡Œ,é»˜è®¤æ˜¯rootç”¨æˆ·
* ç”¨æˆ·å`root`å¯†ç ä¸ºç©º
* `Alt+F8`æˆ–è€…è¾“å…¥`nixos-help`æ˜¾ç¤ºè‡ªå¸¦æ‰‹å†Œæ–‡æ¡£,`Ctrl-z`é€€å‡º

## ç½‘ç»œ
* ç½‘ç»œå¿…é¡»è¦é…ç½®é€š,é»˜è®¤æ‰“å¼€kdeæ¡Œé¢ç¯å¢ƒæ˜¯å·²ç»è‡ªåŠ¨è¿æ¥ç½‘ç»œäº†çš„,å®‰è£…è¿‡ç¨‹éœ€è¦ä¸‹è½½æ–‡ä»¶,æŸ¥çœ‹çŠ¶æ€`ip a`,æ‰‹åŠ¨é…ç½®ç½‘ç»œ`ifconfig`æ¥é…ç½®,è¿™é‡Œä¸åšå¤šä»‹ç»
* è¦åœ¨å›¾å½¢å®‰è£…ç¨‹åºä¸Šæ‰‹åŠ¨é…ç½®ç½‘ç»œï¼Œè¯·é¦–å…ˆä½¿ç”¨`systemctl stop network manager`ç¦ç”¨ç½‘ç»œç®¡ç†å™¨
* å¦‚éœ€ä½¿ç”¨ssh,å¼€å¯sshå®ˆæŠ¤è¿›ç¨‹`systemctl start sshd`
* æ²¡æœ‰å›¾å½¢åŒ–ç•Œé¢è¿æ¥wifi,æŸ¥çœ‹ç½‘å¡å`ip a`,è¿æ¥`wpa_supplicant -B -i ç½‘å¡å -c <(wpa_passphrase 'wifiå' 'wifiå¯†ç ')`

## åˆ†åŒºå®‰è£…ç›˜,æ¢äº†ä¸ª1tbçš„å›ºæ€,å…¨éƒ¨ä½¿ç”¨ext4(ç”±lvmå’Œbtrfsåˆ‡æ¢å›æ¥)

```shell
# æŸ¥çœ‹æŒ‚è½½çš„ç£ç›˜
lsblk

# partedè¯·è°¨æ…æ“ä½œ,ä¼šæ ¼å¼åŒ–ç£ç›˜
# è½¬æ¢ç¡¬ç›˜gptæ ¼å¼
parted /dev/nvme0n1 -- mklabel gpt
# æŸ¥çœ‹æ˜¯å¦æ˜¯gpt,æŸ¥çœ‹Disklabel typeç±»å‹
fdisk -l

# åªè¦ä¸¤ä¸ªåˆ†åŒºEFIå’Œ/ä¸»åˆ†åŒºå³å¯å®‰è£…,å…¶å®å°±æ˜¯è¿è¡Œparted /dev/nvme0n1å‘½ä»¤,ç„¶åæŒ‰ç…§æç¤ºè¿›è¡Œä¸€æ­¥ä¸€æ­¥æ“ä½œå³å¯; åˆ†åŒºåç§°,åˆ†åŒºç±»å‹,èµ·ç‚¹,ç»ˆç‚¹

parted /dev/nvme0n1 -- mkpart uefi_esp fat32 1MiB 512MiB
parted /dev/nvme0n1 -- mkpart primary_ext ext4 512MiB -1MiB

# æŸ¥çœ‹åˆ†åŒºæƒ…å†µ
lsblk -a
# è®¾ç½®å¯åŠ¨åˆ†åŒº, å…ˆæŸ¥çœ‹EFIç¼–å·(Number),å†æ‰§è¡Œ,åº”è¯¥å°±æ˜¯1
parted -l
parted /dev/nvme0n1 -- set ç¼–å· boot on
# æŸ¥çœ‹åˆ†åŒºä¿¡æ¯,èƒ½çœ‹åˆ°efiåˆ†åŒºçš„Flagsæ˜¯[boot, esp]
parted -l


# å¼€å§‹æ ¼å¼åŒ–åˆ†åŒº
# efiåˆ†åŒºæ ¼å¼åŒ–ä¸ºfat32
mkfs.fat -F 32 /dev/nvme0n1p1
# ä¸»åˆ†åŒºå…¨éƒ¨æ ¼å¼åŒ–ä¸ºext4
mkfs.ext4 -L nixos /dev/nvme0n1p2

# æŸ¥çœ‹ç»“æœ,Fileåˆ—é‡Œé¢
parted -l

# uefiç±»å‹æŒ‚è½½
mount /dev/nvme0n1p2 /mnt
mkdir -p /mnt/boot
mount /dev/nvme0n1p1 /mnt/boot


# è½¬ç§»åŸæ¥çš„sda1åˆ†åŒºæ‰€æœ‰/ä¸‹æ–‡ä»¶
mkdir -p /old/mnt
mount /dev/sda1 /old/mnt
cp -aR /old/mnt /
# æ³¨æ„é‡æ–°ä¿®æ”¹æŒ‚è½½ç‚¹
vi /mnt/etc/nixos/hardware-configuration.nix
```

## è™šæ‹Ÿæœºå®‰è£…,é€šå¸¸ä¸æ˜¯uefiå¯åŠ¨

```shell
# æŸ¥çœ‹æŒ‚è½½çš„ç£ç›˜
lsblk

# partedè¯·è°¨æ…æ“ä½œ,ä¼šæ ¼å¼åŒ–ç£ç›˜
# è½¬æ¢ç¡¬ç›˜msdosæ ¼å¼
parted /dev/sdb
mklabel msdos
q
# æŸ¥çœ‹æ˜¯å¦æ˜¯gpt,æŸ¥çœ‹Disklabel typeç±»å‹
fdisk -l

# åªè¦ä¸€ä¸ªä¸»åˆ†åŒº
parted /dev/sdb
mkpart primary
ext4
1MiB
-1MiB
q

# æŸ¥çœ‹åˆ†åŒºæƒ…å†µ
lsblk -a

# å¼€å§‹æ ¼å¼åŒ–åˆ†åŒº
mkfs.ext4 -L nixos /dev/sdb1

# æŸ¥çœ‹ç»“æœ,Fileåˆ—é‡Œé¢
parted -l

# æŒ‚è½½
mount /dev/sdb1 /mnt

# æŸ¥çœ‹
lsblk

# é…ç½®æ–‡ä»¶ä¿®æ”¹å¼•å¯¼ç›˜: /mnt/etc/nixos/configuration.nix
boot.loader.grub.device = "/dev/sdb"; # or "nodev" for efi only
```


* é…ç½®æ–‡ä»¶ç”Ÿæˆ

```shell
nixos-generate-config --root /mnt/
```

* å¸¸è§„ä¿®æ”¹é…ç½®

```shell
nano /mnt/etc/nixos/configuration.nix
```
* å®‰è£…

```shell
nixos-install --root /mnt
```

* chrootè¿›ç³»ç»Ÿæ”¹æ™®é€šç”¨æˆ·å¯†ç 

```shell
nix-enter --root /mnt
```



## é…ç½®è¯´æ˜ configuration.nix

> ä½ç½®:å®‰è£…ä¹‹å‰`/mnt/etc/nixos/configuration.nix`,å®‰è£…ä¹‹å`/etc/nixos/configuration.nix`

> [å®˜æ–¹é…ç½®è¯¦è§£](https://nixos.org/nixos/manual/options.html)

> æŸ¥çœ‹å½“å‰å¯åŠ¨ç³»ç»Ÿå¼•å¯¼ç±»å‹

```shell
# å­˜åœ¨å°±æ˜¯UEFI,ä¸å­˜åœ¨å°±æ˜¯BIOS
ls /sys/firmware/efi
```
> é…ç½®ä¹‹åè¯·`nixos-rebuild switch`é»˜è®¤è®¾ä¸ºé»˜è®¤é€‰é¡¹,`nixos-rebuild test`ä¸è®¾ä¸ºé»˜è®¤é€‰é¡¹,é‡è½½é…ç½®,æ¯ä¸€æ¬¡é…ç½®ä¹‹åå°±ä¼šç”Ÿæˆä¸€ä¸ªgrubå¼•å¯¼,æ–¹ä¾¿å›æ»š

> åŸºç¡€é…ç½®

```config
{ config, pkgs, ... }: {
  imports = [
    # ä½¿ç”¨é»˜è®¤çš„ç¡¬ä»¶é…ç½®
    ./hardware-configuration.nix
  ];

  boot.loader.grub.device = "/dev/sda";   # (for BIOS systems only,ç¡¬ç›˜ä½ç½®)
  boot.loader.systemd-boot.enable = true; # (for UEFI systems only)
  boot.loader.grub.efiSupport = true;     # grubæ˜¯å¦æ”¯æŒefi

  # Enable the OpenSSH server.
  services.sshd.enable = true;
}
```
> å¸¸ç”¨é…ç½®

```
# æœ‰å…¶ä»–ç³»ç»Ÿå¦‚win10,è‡ªåŠ¨æ·»åŠ åˆ°grub
boot.loader.grub.useOSProber = true;

# é…ç½®wifi,networkmanageräºŒé€‰ä¸€, æ¨ènetworkmanager
# networking.wireless.enable = true;  # Enables wireless support via wpa_supplicant.
## è¿è¡Œå‘½ä»¤ç”Ÿæˆwifiå¯†é’¥é…ç½®ï¼Œpsk2çš„æ‰æ”¯æŒè‡ªåŠ¨ç”Ÿæˆ: wpa_passphrase wanlaimeng wanlaimeng168 > /etc/wpa_supplicant.conf
## å¦‚æœæ˜¯åœ¨cliè¿æ¥wifi,è‡ªåŠ¨ç”Ÿæˆå¯†ç ä¹‹å,  restartæœåŠ¡ systemctl restart wpa_supplicant.service

# æœ‰çº¿ç½‘ç»œç®¡ç†,ä¸åŒæ—¶ä½¿ç”¨networking.wireless,è¿™ä¸ªå³ä¸‹è§’ä¼šæ˜¾ç¤º
networking.networkmanager.enable = true;

# é…ç½®ä»£ç†æœåŠ¡å™¨
# curl -o csnet https://csnet.aite.xyz/files/csnet_client/csnet_client_linux_amd64
# chmod 777 ./csnet
# networking.proxy.default = "http://127.0.0.1:54321/";
networking.proxy.default = "http://user:password@proxy:port/";
networking.proxy.noProxy = "127.0.0.1,localhost";

# æ™®é€šç”¨æˆ·é…ç½®
# ç”¨æˆ·å:jcleng
# å¯†ç :123456
# ç”¨æˆ·ä½¿ç”¨nixé…ç½®,useraddç­‰æ“ä½œä¼šåœ¨é‡å¯æ—¶å¤±æ•ˆ
users.mutableUsers = true;
users.users.jcleng = {
  isNormalUser = true;
  home = "/home/jcleng";
  description = "jcleng"; # ç”¨æˆ·å…¨å
  extraGroups = [ "wheel" "networkmanager" ]; # rootç»„å’Œç½‘ç»œç»„
  # openssh.authorizedKeys.keys = [ "ssh-dss AAAAB3Nza... alice@foobar" ];
};
# åœ¨å‘½ä»¤è¡Œè®¾ç½®å¯†ç 
# passwd jcleng
# æˆ–è€…ï¼Œé…ç½®å¯†ç 
users.users.jcleng.password = "123456";

# ä¸»æœºåç§°
networking.hostName = "jcleng";

# å¼€å¯å£°éŸ³ï¼Œè¿™ä¸ªå³ä¸‹è§’ä¼šæ˜¾ç¤º
sound.enable = true;
hardware.pulseaudio.enable = true;

# æ”¯æŒå›¾å½¢åŒ–è¯·å¼€å¯xserveræœåŠ¡
services.xserver.enable = true;
services.xserver.layout = "us";

# å¼€å¯xserveræœåŠ¡ä¹‹åæ‰èƒ½ä½¿æ¡Œé¢ç¯å¢ƒ,é•œåƒé‡Œé¢å¸¦æœ‰plasma5(å®‰è£…çš„æ—¶å€™ç›´æ¥ä»localè·å–ä¸ä¸‹è½½,å¿«ä¸€ç‚¹),é‚£å°±å¼€å¯ç¬¬ä¸€ä¸ªplasma5,å…¶ä»–çš„è‡ªè¡Œå®‰è£…
services.xserver.desktopManager.plasma5.enable = true;
# services.xserver.desktopManager.xfce.enable = true;
# services.xserver.desktopManager.gnome3.enable = true;
# services.xserver.desktopManager.mate.enable = true;
# services.xserver.windowManager.xmonad.enable = true;
# services.xserver.windowManager.twm.enable = true;
# services.xserver.windowManager.icewm.enable = true;
# services.xserver.windowManager.i3.enable = true;

# ç™»å½•ç®¡ç†å™¨,æ¨èä½¿ç”¨ç¬¬ä¸€ä¸ª
services.xserver.displayManager.sddm.enable = true;
# services.xserver.displayManager.slim.enable = true;

# NVIDIA æ˜¾å¡é©±åŠ¨
services.xserver.videoDrivers = [ "nvidia" ];

# è§¦æ‘¸æ¿
services.xserver.libinput.enable = true;

# åœ°åŒºé…ç½®
i18n.supportedLocales = [ "zh_CN.UTF-8/UTF-8" "en_US.UTF-8/UTF-8" ];
i18n.defaultLocale = "zh_CN.UTF-8";
# å¦‚æœæ˜¯ 21.05ç‰ˆæœ¬+ æ˜¯ i18n.console = { KeyMap = "us" }
i18n.consoleKeyMap = "us";
# Fcitxè¾“å…¥æ³•
i18n.inputMethod = {
  enabled = "fcitx";
};

# fcitxæ‹¼éŸ³åŒ…
i18n.inputMethod.fcitx.engines = with pkgs.fcitx-engines; [ cloudpinyin libpinyin rime ];

# æ—¶åŒºé…ç½®
time.timeZone = "Asia/Shanghai";

# å­—ä½“é…ç½®
fonts = {
  fontconfig.enable = true;
  enableFontDir = true;
  enableGhostscriptFonts = true;
  fonts = with pkgs; [
    noto-fonts
    noto-fonts-cjk
    noto-fonts-emoji
    wqy_microhei
    wqy_zenhei
  ];
};

# å®‰è£…è½¯ä»¶,é»˜è®¤å®‰è£…æ—¶æ²¡æœ‰æµè§ˆå™¨/ç½‘ç»œç®¡ç†å™¨ç­‰çš„
environment.systemPackages = with pkgs; [
  wget
  vim
  firefox
  git
  fcitx
  fcitx-configtool
];

# ä¿®æ”¹é…ç½®ä¹‹åå¿…é¡»
nixos-rebuild switch


### å®‰è£…21.05ç‰ˆæœ¬å‡ºç° /nix/store/...: No such file or directory issues: https://github.com/NixOS/nixpkgs/issues/126141
# è¿™æ ·å¤„ç†: https://github.com/NixOS/nixpkgs/issues/126141#issuecomment-877883570
sudo nix-build '<nixpkgs/nixos>' -A config.system.build.toplevel -I nixos-config=/mnt/etc/nixos/configuration.nix
sudo nixos-install
```
## å®‰è£…è½¯ä»¶
> [åœ¨çº¿åŒ…æŸ¥çœ‹](https://nixos.org/nixos/packages.html)

> suå‘½ä»¤è¡Œä½¿ç”¨
```
# æœç´¢(-uç”Ÿæˆç¼“å­˜ï¼Œæœç´¢æ›´å¿«)
nix search -u
nix search wget
nix-env -aqP | grep vscode
# å®‰è£…vscode
# å…ˆå¼€å¯allowUnfree
nixpkgs.config = {
  # å¼€å¯Unfree
  allowUnfree = true;
  # æ”¯æŒæŸåçš„åŒ…
  allowBroken = true;
};
# å¼€å¯ä¹‹åè¿˜è¦å¯¹å•ç‹¬çš„ç”¨æˆ·è¿›è¡Œé…ç½®
nano ~/.config/nixpkgs/config.nix
{
  allowUnfree = true;
  allowBroken = true;
}

# é‡æ–°åŠ è½½é…ç½®(é‡å¯)
nixos-rebuild switch
# å®‰è£…
nix-env -i vscode

# å®‰è£…è½¯ä»¶(proxychains4æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œä½¿ç”¨ä»£ç†çš„è½¯ç”²,éœ€è¦å…ˆå®‰è£…)
nix-env -i nodejs
# proxychains4 nix-env -i nodejs

# æ¸…é™¤packageså‘½ä»¤
nix-collect-garbage

# æŸ¥çœ‹å·²å®‰è£…çš„åŒ…
nix-env -qaP '*' --description

# æ•´ä¸ªç³»ç»Ÿå›æ»š
nixos-rebuild switch --rollback

```
## å‡çº§
```
# æŸ¥çœ‹å‡çº§é€šé“
nix-channel --list
# æ·»åŠ 
nix-channel --add https://nixos.org/channels/nixos-19.03 nixos
# å‡çº§åˆ°æœ€æ–°
nixos-rebuild switch --upgrade
# å¾ˆå¤šæ—¶å€™ä¸‹è½½ä¼šå‡ºç°æ–­å¼€ --keep-going
nix-env -i nodejs linux php openjdk --keep-going
```
### æ­å»ºç¯å¢ƒç­‰
```shell
# å‘½ä»¤è·¯å¾„åœ¨`which php`(/home/jcleng/.nix-profile/bin/php)
# /home/jcleng/.nix-profile/lib/openjdk
nix-env -i openjdk neofetch php google-chrome gedit tilix tmux
```
> æ„Ÿå—
```
# ç¡®å®å¸¦æœ‰nix-pkgåŒ…ç®¡ç†å·¥å…·çš„å‘è¡Œç‰ˆç¡®å®å¯ä»¥æ˜¯ä¸€ä¸ªå¥½çš„å‘è¡Œç‰ˆï¼Œä½†æ˜¯å¯¹äºæƒ³è¦ç¼–è¯‘å®‰è£…çš„è½¯ä»¶å¾€å¾€è¾¾ä¸åˆ°ç†æƒ³çš„è¦æ±‚ï¼Œå¤ªç¹çï¼Œé—¨æ§›å¤ªé«˜ï¼Œä½•ä¸åœ¨å…¶ä»–å‘è¡Œç‰ˆå®‰è£…nixpkgåŒ…ç®¡ç†å·¥å…·å‘¢
```

### æœ€è¿‘æ›´æ–°äº†æ¸…åæº[æ¸…å Nix é•œåƒä½¿ç”¨å¸®åŠ©](https://mirrors.tuna.tsinghua.edu.cn/help/nix/)

```shell
# æˆ‘åœ¨ubuntuå®‰è£…äº†nixåŒ…ç®¡ç†å·¥å…·,å›½å†…æºç½‘ç»œå·²ç»å¾ˆå¿«äº†
# å›½å†…æºå¸®åŠ©: https://mirrors.tuna.tsinghua.edu.cn/help/nix/
# ustcæº https://mirrors.ustc.edu.cn/nix-channels/store
nix-channel --add https://mirrors.tuna.tsinghua.edu.cn/nix-channels/nixpkgs-unstable nixpkgs
nix-channel --add https://mirrors.ustc.edu.cn/nix-channels/nixos-21.05/ nixos
# nix-channel --add https://mirrors.ustc.edu.cn/nix-channels/nixpkgs-21.05-darwin/ darwin

# å•ç‹¬å®‰è£…çš„ Nix ,å¯æ‰§è¡Œç›®å½•
~/.nix-profile/bin

# é…ç½®
cat ~/.bash_profile
export PATH="$PATH:/home/leng/.nix-profile/bin"

# ç¼“å­˜æºåœ°å€ä¿®æ”¹
cat ~/.config/nix/nix.conf
substituters = https://mirrors.tuna.tsinghua.edu.cn/nix-channels/store

cat ~/.config/nixpkgs/config.nix

{
  allowUnfree = true;
  allowBroken = true;
  allowUnsupportedSystem = true;
  allowInsecurePredicate = (pkg: true);
  allowUnfreePredicate = (pkg: false);
  #packageOverrides = pkgs: {
  #  nur = import (builtins.fetchTarball "https://github.com/nix-community/NUR/archive/master.tar.gz") {
  #    inherit pkgs;
  #  };
  #};
}

# æ›´æ–°ä¸€ä¸‹
nix-channel --update

# å¦‚æœæç¤º  SSL peer certificate or SSH remote key was not OK (60)
# é…ç½®NIX_SSL_CERT_FILEç¯å¢ƒå˜é‡å€¼ä¸º/etc/ssl/certs/ca-bundle.crt å‚è€ƒ: https://github.com/NixOS/nixpkgs/issues/70939
echo $NIX_SSL_CERT_FILE
/etc/ssl/certs/ca-bundle.crt

# ç¡®ä¿åœ¨ nix show-config å‘½ä»¤ç»“æœä¸­çš„substitutersä¸­,åªæœ‰tsinghuaæº

...çœç•¥
substitute = true
substituters = https://mirrors.tuna.tsinghua.edu.cn/nix-channels/store
...çœç•¥

# æµ‹è¯•å®‰è£…(å¯æ˜ç¡®çœ‹åˆ° from 'https://mirrors.tuna.tsinghua.edu.cn/' å³æ¢æºæˆåŠŸ)
nix-env -i hello

# å®‰è£…å®Œæˆå³å¯æ‰§è¡Œ
hello
# Hello, world!

# æœç´¢è½¯ä»¶
nix-env -qa 'hello'
nix-env -qa 'neofetch'
# å®‰è£…
nix-env -i neofetch
```

- æ›´åŠ è¯¦ç»†çš„æœç´¢&&å®‰è£…

```shell
# æ›´åŠ è¯¦ç»†çš„æœç´¢æ•°æ®,(ä¹‹å‰çš„æœç´¢ä¸èƒ½æœç´¢åˆ°php73)å‚è€ƒåšå®¢ https://www.domenkozar.com/2014/01/02/getting-started-with-nix-package-manager/
nix-env -qaP | grep php

# ç»“æœ

...

nixpkgs.php73                                                            php-with-extensions-7.3.25
nixpkgs.php                                                              php-with-extensions-7.4.13
nixpkgs.php80                                                            php-with-extensions-8.0.0
nixpkgs.php73Extensions.xdebug                                           php-xdebug-3.0.1
nixpkgs.php74Extensions.xdebug                                           php-xdebug-3.0.1
nixpkgs.php80Extensions.xdebug

...

# å®‰è£…php8(ä½¿ç”¨ç¬¬äºŒåˆ—çš„idåç§°)
nix-env -i php-with-extensions-8.0.0

# å…¶ä»–
# é…ç½®NIX_PATHå˜é‡ç¯å¢ƒ é…ç½®ä¹‹åæ‰èƒ½nix searchå‘½ä»¤
export NIX_PATH=/home/leng/.nix-defexpr/channels
echo $NIX_PATH

# å®‰è£…searchçš„åŒ…
# * nixpkgs.xorg.xf86inputlibinput (xf86-input-libinput)

nix-env -iA nixpkgs.xorg.xf86inputlibinput
```

#### åœ¨macosä¸Šé…ç½®å®‰è£…nixåŒ…ç®¡ç†å·¥å…·

```shell
# ä¸‹è½½
aria2c https://mirrors.tuna.tsinghua.edu.cn/nix/nix-2.3.9/nix-2.3.9-x86_64-darwin.tar.xz
# å®‰è£…
./install --darwin-use-unencrypted-nix-store-volume
# è¾“å…¥ç”¨æˆ·å¯†ç 
# å®‰è£…å®Œæˆæç¤º
modifying /Users/jcleng/.bash_profile...
modifying /Users/jcleng/.zshrc...
Installation finished!  To ensure that the necessary environment
variables are set, either log in again, or type

  . /Users/jcleng/.nix-profile/etc/profile.d/nix.sh

in your shell.
# é‡æ–°ç™»å½•æˆ–è€…æ‰§è¡Œ
sh /Users/jcleng/.nix-profile/etc/profile.d/nix.sh


# æ‰§è¡Œä»nixå‘½ä»¤æ— æ•ˆ,è¯·å¾€ä¸‹çœ‹,æˆ‘è¿™è¾¹æ˜¯fish,è¿™é‡Œnixé»˜è®¤åªå†™å…¥äº†.bash_profileå’Œ.zshrc,é‚£ä¹ˆæ‰‹åŠ¨å†™å…¥è¿›fish,æŸ¥çœ‹ nix.sh é‡Œé¢çš„å˜é‡ç¯å¢ƒ
cat /Users/jcleng/.nix-profile/etc/profile.d/nix.sh

# æœ‰é‚£äº›
# NIX_LINK=$HOME/.nix-profile åŸºæœ¬è·¯å¾„
export NIX_PATH=${NIX_PATH:+$NIX_PATH:}$HOME/.nix-defexpr/channels
export NIX_PROFILES="/nix/var/nix/profiles/default $HOME/.nix-profile"
export NIX_SSL_CERT_FILE=/etc/ssl/certs/ca-certificates.crt
export NIX_SSL_CERT_FILE=/etc/ssl/ca-bundle.pem
export NIX_SSL_CERT_FILE="$NIX_LINK/etc/ca-bundle.crt"
export MANPATH="$NIX_LINK/share/man:$MANPATH"
export PATH="$NIX_LINK/bin:$PATH"

# ç¼–è¾‘fishé…ç½®æ–‡ä»¶
vim /Users/jcleng/.config/fish/conf.d/omf.fish


# å¯¹åº”æ–°å¢
set -x NIX_PATH /Users/jcleng/.nix-defexpr/channels
set -x NIX_PROFILES /nix/var/nix/profiles/default /Users/jcleng/.nix-profile
# å¦‚æœæœ¬æœºæ²¡æœ‰çš„è¯,å°±ä½¿ç”¨è‡ªå¸¦çš„
set -x NIX_SSL_CERT_FILE /Users/jcleng/.nix-profile/etc/ssl/certs/ca-bundle.crt
set -x MANPATH /Users/jcleng/.nix-profile/share/man $MANPATH
# æœ€é‡è¦çš„å¯æ‰§è¡Œå‘½ä»¤è·¯å¾„
set -x PATH /Users/jcleng/.nix-profile/bin $PATH
# æˆ‘ä¹‹å‰å·²ç»æœ‰ PATH äº†,é‚£ä¹ˆç›´æ¥è¿½åŠ ä¸€ä¸ª
set -x PATH /Users/jcleng/.nix-profile/bin /Users/jcleng/Downloads/flutter/bin /usr/local/axe/bin $PATH

# é…ç½®ä¿å­˜,ç„¶åfishé‡æ–°æ‰“å¼€, å†æ‰§è¡Œnixå‘½ä»¤å³å¯
nix


# åˆ›å»ºä¸€ä¸ªphp71ç¯å¢ƒ
nix-env -p /nix/var/nix/profiles/per-user/leng/dev-php71 -i nix git
# åˆ‡æ¢å½“å‰ç¯å¢ƒ
nix-env --switch-profile /nix/var/nix/profiles/per-user/leng/dev-php71
# é»˜è®¤ç¯å¢ƒ(é‡å¯shellç”Ÿæ•ˆ)
nix-env --switch-profile /nix/var/nix/profiles/per-user/leng/profile

```
- ç‰ˆæœ¬å…±å­˜å’Œå›æ»š

```shell
# å¤šä¸ªç‰ˆæœ¬å…±å­˜
## å…ˆè®¾ç½®ä¹‹å‰çš„ä¸º active false, å¦åˆ™æç¤º(i.e., canâ€™t have two active at the same time), åˆ‡æ¢çš„è¯éœ€æ‰§è¡Œè¿™é‡Œ2æ¡å‘½ä»¤å³å¯
nix-env --set-flag active false php-with-extensions-7.3.25
nix-env --set-flag active true php-with-extensions-8.0.0
# åˆ‡æ¢,æœ€å¥½ false åœ¨å‰
nix-env --set-flag active false php-with-extensions-8.0.0
nix-env --set-flag active true php-with-extensions-7.3.25

# nuråˆ‡æ¢
ls -l /home/jcleng/.nix-profile/bin/php
# lrwxrwxrwx 1 jcleng jcleng 62 Jan  1  1970 /home/jcleng/.nix-profile/bin/php -> /nix/store/499zg22sagzbbg27z5hlb466qpj88va6-php-7.1.33/bin/php*
nix-env --set-flag active false php-7.1.33
nix-env --set-flag active true php-7.1.33

## ç„¶åå†å®‰è£…ä¸åŒçš„ç‰ˆæœ¬
nix-env --preserve-installed -i php-with-extensions-8.0.0

# æŸ¥çœ‹è®°å½•
nix-env --list-generations
# åˆ é™¤è®°å½•
nix-env --delete-generations 3 4 8
# åˆ é™¤è®°å½•, åªä¿ç•™5ä¸ª
nix-env --delete-generations +5
# åˆ é™¤30då‰è®°å½•
nix-env --delete-generations 30d
# åˆ é™¤æ‰€æœ‰ åªä¿ç•™current
nix-env --delete-generations old
# å›æ»šæŒ‡å®šè®°å½•
nix-env {--switch-generation | -G} {generation}
# å›æ»šä¸Šä¸€æ¡è®°å½•
nix-env --rollback
```

- [é•œåƒä¸‹è½½å¤§æ–‡ä»¶é¢‘ç¹å‡ºé”™/æ–­æµ](https://github.com/tuna/issues/issues/797#issuecomment-742458245)

```shell
# å¯ä»¥æ¢ä¸€ä¸ªåœ°å€
# åˆ‡æ¢é•œåƒåœ°å€
nix-channel --add https://mirrors.bfsu.edu.cn/nix-channels/nixpkgs-unstable nixpkgs

# ç¼–è¾‘æº
cat ~/.config/nix/nix.conf
# substituters = https://mirrors.bfsu.edu.cn/nix-channels/store

# æ›´æ–°
nix-channel --update
```

- é…ç½®nixåŒ…é•œåƒä»£ç†

```shell
# ä»£ç†æœºå™¨å®‰è£…nix-serve,è¿è¡Œ:
nix-serve -p 8080
```

```shell
# å®¢æˆ·ç«¯ç¼–è¾‘é…ç½®æ–‡ä»¶binary-cachesè®¾ç½®ä¸ºä»£ç†æœåŠ¡å™¨çš„åœ°å€
cat ~/.config/nix/nix.conf
# substitutersæ³¨é‡Šæ‰,ä¿®æ”¹ä¸ºbinary-caches
# substituters = https://mirrors.tuna.tsinghua.edu.cn/nix-channels/store
binary-caches = http://192.168.1.91:8080/
require-sigs = false

# ä¿å­˜ä¹‹åæ‰§è¡Œ
# substitutersé…ç½®å·²ç»æ˜¯ä»£ç†æœåŠ¡å™¨çš„åœ°å€
nix show-config
nix-channel --update
```

- nurä½¿ç”¨

```shell
# æ ¼å¼åŒ–.nixæ–‡ä»¶æ’ä»¶`jnoortheen.nix-ide` `bbenoist.nix`(vscode)
# .nixæ–‡ä»¶æ¢è¡Œç¬¦å·ç”¨lf
nix-env -iA nixpkgs.nixpkgs-fmt

# å‰æå®‰è£…proxychains4æ¥èµ°proxy
nix-env -iA nixpkgs.proxychains
# é…ç½® /etc/proxychains4.conf
socks5  127.0.0.1 54321
# æµ‹è¯•
proxychains4 curl google.com
# åˆ«å vim ~/.config/fish/config.fish
alias nix-env='proxychains4 nix-env'
alias nix='proxychains4 nix'
alias nix-channel='proxychains4 nix-channel'


# ä½¿ç”¨NUR
https://github.com/nix-community/NUR

cat ~/.config/nixpkgs/config.nix

{
  packageOverrides = pkgs: {
    nur = import (builtins.fetchTarball "https://github.com/nix-community/NUR/archive/master.tar.gz") {
      inherit pkgs;
    };
  };
}

# æµ‹è¯•å®‰è£…nur.repos.mic92.hello-nur
nix-env -f '<nixpkgs>' -iA nur.repos.mic92.hello-nur
# nuråŒ…åˆ—è¡¨
https://nur.nix-community.org/repos/izorkin/

# æœç´¢
http://nur.nix-community.org/repos/
## é…ç½®~/.config/nixpkgs/config.nixæ–‡ä»¶ä¹‹åä½¿ç”¨ -f '<nixpkgs>' æœç´¢
nix search php71 -f '<nixpkgs>' -u

# phpç›¸å…³
http://nur.nix-community.org/repos/izorkin/
# å®‰è£…php71
nix-env -f '<nixpkgs>' -iA nur.repos.izorkin.php71
# ç¯å¢ƒ
nix-shell -p nur.repos.izorkin.php73

# æ³¨æ„åœ¨wslä¸Šå¯èƒ½ä¼šé‡åˆ°å®‰è£…æ— æ³•ä½¿ç”¨busyboxçš„æƒ…å†µ,å¯¼è‡´busyboxçš„å‘½ä»¤éƒ½æ— æ³•ä½¿ç”¨ https://github.com/nix-community/NUR/issues/319


# nuræˆ–è€…ç›´æ¥æ·»åŠ ä»“åº“çš„channel
nix-channel --add https://github.com/nix-community/NUR/archive/master.tar.gz nur

# æœ‰çš„auråŒ…å·²ç»æä¾›äº†cachix,ä½¿ç”¨cachix useæ·»åŠ ç¼“å­˜ä»“åº“
nix-env -iA nixpkgs.cachix
# https://github.com/Izorkin/nur-packages
cachix use izorkin
# https://github.com/fossar/nix-phps
cachix use fossar
# nix-community
cachix use nix-community
# ä½¿ç”¨cachix useå‘½ä»¤ä¹‹å,ä¼šæç¤ºå·²ç»ä¿®æ”¹äº†~/.config/nix/nix.confé…ç½®æ–‡ä»¶, https://cache.nixos.org è¿™ä¸ªå¯ä»¥ä¿®æ”¹ä¸ºå›½å†…æº(åˆ é™¤)
cat ~/.config/nix/nix.conf

substituters = https://cache.nixos.org https://mirrors.tuna.tsinghua.edu.cn/nix-channels/store https://izorkin.cachix.org https://nix-community.cachix.org
trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= fossar.cachix.org-1:Zv6FuqIboeHPWQS7ysLCJ7UT7xExb4OE8c4LyGb5AsE= izorkin.cachix.org-1:hwG3g4ZCbuC1eOZjGtQ/ESxwBxigCHs205Kz1iuMiJA= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=

nix-env -f '<nixpkgs>' -iA nur.repos.mic92.hello-nur ä¼šç›´æ¥çœ‹åˆ°:

nix-env -f '<nixpkgs>' -iA nur.repos.mic92.hello-nur...
...

nix-env -f '<nixpkgs>' -iA nur.repos.izorkin.php71 ä¼šç›´æ¥çœ‹åˆ°:

...
copying path '/nix/store/k7yvdrvf0vzl27gmfqvi2ya3r2qgbz20-php-7.1.33-debug' from 'https://izorkin.cachix.org'...
...

```

- å¼•å¯¼é…ç½®,åŸæ–‡

```nix
  # Use the GRUB 2 boot loader.
  boot.loader.grub.enable = true;
  boot.loader.grub.version = 2;
  # boot.loader.grub.efiSupport = true;
  # boot.loader.grub.efiInstallAsRemovable = true;
  # boot.loader.efi.efiSysMountPoint = "/boot/efi";
  # Define on which hard drive you want to install Grub.
  # ä¼ ç»Ÿæ¨¡å¼(æ¯”å¦‚æœåŠ¡å™¨ä¸Š),efiè®¾ç½®nodev
  boot.loader.grub.device = "/dev/vda"; # or "nodev" for efi only

```

### `cache.nixos.org`ç¼“å­˜éå¸¸æ…¢,æˆ–è€…è€æ˜¯å‡ºé”™,è‡ªå»ºhttpæœåŠ¡ä»£ç†ä¸€ä¸‹



```
# å‚è€ƒæ–‡ç« 

FAQ/Private Cache Proxy
https://nixos.wiki/wiki/FAQ/Private_Cache_Proxy


How to make a local NixOS cache server
https://dataswamp.org/~solene/2022-06-02-nixos-local-cache.html
```


- `cache.jcleng.net`æ›¿æ¢ä¸ºåŸŸå

```nix
  services.nginx = {
    enable = true;
    appendHttpConfig = ''
      proxy_cache_path /tmp/pkgcache levels=1:2 keys_zone=cachecache:100m max_size=20g inactive=365d use_temp_path=off;

      # Cache only success status codes; in particular we don't want to cache 404s.
      # See https://serverfault.com/a/690258/128321
      map $status $cache_header {
        200     "public";
        302     "public";
        default "no-cache";
      }
      access_log /tmp/nginx_access.log;
    '';

    virtualHosts."cache.jcleng.net" = {
      locations."/" = {
        root = "/var/public-nix-cache";
        extraConfig = ''
          expires max;
          add_header Cache-Control $cache_header always;
          # Ask the upstream server if a file isn't available locally
          error_page 404 = @fallback;
        '';
      };

      extraConfig = ''
        # Using a variable for the upstream endpoint to ensure that it is
        # resolved at runtime as opposed to once when the config file is loaded
        # and then cached forever (we don't want that):
        # see https://tenzer.dk/nginx-with-dynamic-upstreams/
        # This fixes errors like
        #   nginx: [emerg] host not found in upstream "upstream.example.com"
        # when the upstream host is not reachable for a short time when
        # nginx is started.
        resolver 114.114.114.114;
        set $upstream_endpoint http://cache.nixos.org;
      '';

      locations."@fallback" = {
        proxyPass = "$upstream_endpoint";
        extraConfig = ''
          proxy_cache cachecache;
          proxy_cache_valid  200 302  60d;
          expires max;
          add_header Cache-Control $cache_header always;
        '';
      };

      # We always want to copy cache.nixos.org's nix-cache-info file,
      # and ignore our own, because `nix-push` by default generates one
      # without `Priority` field, and thus that file by default has priority
      # 50 (compared to cache.nixos.org's `Priority: 40`), which will make
      # download clients prefer `cache.nixos.org` over our binary cache.
      locations."= /nix-cache-info" = {
        # Note: This is duplicated with the `@fallback` above,
        # would be nicer if we could redirect to the @fallback instead.
        proxyPass = "$upstream_endpoint";
        extraConfig = ''
          proxy_cache cachecache;
          proxy_cache_valid  200 302  60d;
          expires max;
          add_header Cache-Control $cache_header always;
        '';
      };
    };
  };

```

- caddyæœåŠ¡ç«¯ä»£ç†

```caddyfile
cache.jcleng.net:80 {
   reverse_proxy /* https://cache.nixos.org {
      header_up Host cache.nixos.org
      header_up X-Real-IP {remote}
      header_up X-Forwarded-For {remote}
      header_up X-Forwarded-Port {server_port}
      header_up X-Forwarded-Proto "http"
   }
}
```

- ä½¿ç”¨

```shell
sudo nixos-rebuild switch --option substituters http://cache.jcleng.net
```

```nix
nix.binaryCaches = [ "http://cache.jcleng.net" ];
```

code ~/.config/nix/nix.conf

```conf
require-sigs = false
experimental-features = nix-command flakes
substituters = http://cache.jcleng.net https://cache.nixos.org
binary-caches = http://cache.jcleng.net
```


